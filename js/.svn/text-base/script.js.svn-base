/* ria.exos.flatland.be - Notes de cours en ligne pour le cours de RIA - Applications Internet Riches
 * JS Document - /html5/test_one/js/script.js
 * coded by Pierre-Antoine Delnatte
 * october 2012
 */

/*jslint regexp: true, vars: true, white: true, browser: true */
/*global jQuery, google */

( function ( $ ) {
	"use strict";

	var gMap,
		aMarkers = {},
		gOrigin = new google.maps.LatLng( 0, 0 );

	var switchWonder = function ( sWonderID ) {
		var $target = $( 'li[title="' + sWonderID + '"]' );
		$( 'li.active' ).removeClass( 'active' );
		$target.addClass( 'active' );
		$( '#img_wrapper' ).find( 'span.label' ).text( sWonderID ).end().find( 'img' ).attr( 'src', $target.find( 'img' ).attr( 'src' ).replace( /^photos\/(.+)\.jpg$/i, 'photos/$1-big.jpg' ) );
		gMap.setZoom( 7 );
		gMap.panTo( aMarkers[sWonderID].position );
	}; // switchWonder

	var createMap = function () {
		gMap = new google.maps.Map( document.getElementById( 'gmap' ), {
			center: gOrigin,
			zoom: 1,
			mapTypeId: google.maps.MapTypeId.HYBRID
		} );
	}; // createMap

	var createMarker = function () {
		var sMarkerName = $( this ).attr( 'title' ),
			aMarkerPosition = $( this ).attr( 'data-position' ).split( ',' );
		aMarkers[sMarkerName] = new google.maps.Marker( {
			title: sMarkerName,
			map: gMap,
			position: new google.maps.LatLng( parseFloat( aMarkerPosition[0] ), parseFloat( aMarkerPosition[1] ) )
		} );
	}; // createMarker

	var historyHasChanged = function ( e ) {
		if ( e.state !== null ) {
			switchWonder( e.state.id );
		} else {
			gMap.panTo( gOrigin );
			gMap.setZoom( 1 );
			$( '#img_wrapper' ).find( 'span.label' ).text( 'Choisissez une merveille...' ).end().find( 'img' ).attr( 'src', 'http://placehold.it/700x330' );
		}
	}; // historyHasChanged

	var wonderClicked = function () {
		if ( $( this ).hasClass( 'active' ) ) {
			return;
		}
		var sWonderID = $( this ).attr( 'title' );
		switchWonder( sWonderID );
		history.pushState( {id: sWonderID}, sWonderID, sWonderID.toLowerCase().replace( /\s/g, '_' ) + '.html' );
	}; // wonderClicked

	$( function () {
		createMap();
		$( 'section ul li' ).each( createMarker ).on( 'click', wonderClicked );
		window.onpopstate = historyHasChanged;
	} );

}( jQuery ) );
